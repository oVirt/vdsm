#!/bin/sh

# SPDX-FileCopyrightText: Red Hat, Inc.
# SPDX-License-Identifier: GPL-2.0-or-later

if [ -z "$PYTHON_EXE" ]; then
    PYTHON_EXE="python3"
fi

function terminate_jobs {
    running_jobs=$(jobs -pr)
    if [ -n "$running_jobs" ]; then
        kill $running_jobs
    fi
}

trap terminate_jobs EXIT

export \
    LC_ALL=C.UTF8 \
    PYTEST_EVAL_ATTR \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH="@top_srcdir@/static/usr/share/vdsm:@top_srcdir@/lib:@top_srcdir@/lib/vdsm/hook:@top_srcdir@/vdsm_hooks:@top_srcdir@/vdsm_api:$PYTHONPATH" \
    $NULL

if [ -n "$TIMEOUT" ]; then
    PYTHON_EXE="$PYTHON_EXE py-watch $TIMEOUT $PYTHON_EXE"
fi

$PYTHON_EXE "@top_srcdir@"/tests/testrunner.py --local-modules "$@"
